name: Build PCC DLL Toolchain (Linux)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git make zip gcc-multilib

    - name: Build PCC
      run: |
        set -e
        git clone --depth 1 https://github.com/pcc/pcc.git
        cd pcc
        ./configure \
          --target=i386-win32 \
          --disable-tests \
          --disable-debug \
          --disable-shared
        make -j2
        cd lib
        make
        cd ..

    - name: Create minimal distribution
      run: |
        set -e
        mkdir -p dist/bin dist/lib dist/include

        cp pcc/cc/pcc dist/bin/
        cp pcc/as/as dist/bin/
        cp pcc/ld/ld dist/bin/

        cp pcc/lib/libc.a pcc/lib/libm.a pcc/lib/crt0.o dist/lib/

        cp pcc/include/math.h pcc/include/stddef.h pcc/include/stdint.h dist/include/

        cat > dist/include/windows.h <<EOF
        #ifndef _WINDOWS_H_
        #define _WINDOWS_H_
        #define WINAPI
        #define __declspec(x)
        typedef unsigned long DWORD;
        typedef int BOOL;
        #endif
        EOF

        cat > dist/build_dll.sh <<EOF
        #!/bin/bash
        ROOT=\$(dirname "\$0")
        export PATH=\$ROOT/bin:\$PATH
        pcc -c ik.c -o ik.o
        pcc -shared ik.o -L"\$ROOT/lib" -lm -o ik.dll
        echo "DLL built: ik.dll"
        EOF
        chmod +x dist/build_dll.sh

        echo "PCC is BSD licensed." > dist/LICENSE.txt

    - name: Zip toolchain
      run: |
        zip -9 -r pcc-dll-toolchain.zip dist

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: pcc-dll-toolchain
        path: pcc-dll-toolchain.zip
